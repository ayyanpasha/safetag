version: "3.9"

services:
  # ─── Infrastructure ──────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: safetag
      POSTGRES_PASSWORD: safetag
      POSTGRES_DB: safetag
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - safetag
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U safetag"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data
    networks:
      - safetag
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ─── Monolithic Backend ─────────────────────────
  backend:
    build:
      context: .
      dockerfile: services/backend/Dockerfile
    ports:
      - "${PORT:-8080}:8080"
    environment:
      # Core
      PORT: 8080
      NODE_ENV: ${NODE_ENV:-development}
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Database
      DATABASE_URL: postgresql://safetag:safetag@postgres:5432/safetag
      REDIS_URL: redis://redis:6379

      # Security (A02, A07)
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-dev-refresh-secret-change-in-production}
      SESSION_ENCRYPTION_KEY: ${SESSION_ENCRYPTION_KEY:-}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173}
      PUBLIC_URL: ${PUBLIC_URL:-http://localhost:8080}
      PUBLIC_HOST: ${PUBLIC_HOST:-localhost:8080}

      # Razorpay (Payment)
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}
      RAZORPAY_WEBHOOK_SECRET: ${RAZORPAY_WEBHOOK_SECRET:-}
      RAZORPAY_PLAN_MONTHLY: ${RAZORPAY_PLAN_MONTHLY:-}
      RAZORPAY_PLAN_QUARTERLY: ${RAZORPAY_PLAN_QUARTERLY:-}
      RAZORPAY_PLAN_SEMI_ANNUAL: ${RAZORPAY_PLAN_SEMI_ANNUAL:-}
      RAZORPAY_PLAN_YEARLY: ${RAZORPAY_PLAN_YEARLY:-}

      # WhatsApp (Communication)
      WHATSAPP_API_URL_SCANNER: ${WHATSAPP_API_URL_SCANNER:-}
      WHATSAPP_API_URL_OWNER: ${WHATSAPP_API_URL_OWNER:-}
      WHATSAPP_TOKEN_SCANNER: ${WHATSAPP_TOKEN_SCANNER:-}
      WHATSAPP_TOKEN_OWNER: ${WHATSAPP_TOKEN_OWNER:-}

      # TURN Server (VoIP)
      TURN_SERVER_URL: ${TURN_SERVER_URL:-}
      TURN_USERNAME: ${TURN_USERNAME:-}
      TURN_CREDENTIAL: ${TURN_CREDENTIAL:-}

      # S3/R2 Storage (Incident photos)
      S3_BUCKET: ${S3_BUCKET:-safetag-incidents}
      S3_REGION: ${S3_REGION:-ap-south-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      CDN_DOMAIN: ${CDN_DOMAIN:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - safetag
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8080/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
  redisdata:

networks:
  safetag:
    driver: bridge
